<template>
  <li ref="dropdown" class="dropdown dropdown-notifications">
    <a href="javascript:;" @click.prevent="toggleDropdown" style="color:#bcbccb; background:transparent;" class="links" target="_blank">
      <i class="glyphicon glyphicon-bell"></i>
      <span v-if="hasUnread" class="has-notification"></span>
    </a>
    <div class="dropdown-container">
      <div class="dropdown-toolbar">
        <h3 class="dropdown-toolbar-title">Notifications</h3>
      </div>

      <ul class="dropdown-menu">
        <notification v-for="notification in notifications" :key="notification.id" :notification="notification" v-on:read="markAsRead(notification)"></notification>

        <li v-if="!hasUnread" class="notification">
            No unread notifications.
        </li>
      </ul>

      <div v-if="hasUnread" class="dropdown-footer text-center">
        <a href="#" @click.prevent="fetchAll(null)">View all notifications</a>
      </div>
    </div>
  </li>
</template>

<script>
  import $ from 'jquery'
  import axios from 'axios'
  import Notification from './Notification'

  export default {
    components: {
      Notification
    },

    data: () => ({
      total: 0,
      notifications: []
    }),

    mounted() {

      if (window.Echo) {
        this.listen()
      }

      this.initDropdown()
    },

    computed: {
      hasUnread() {
        return this.total > 0
      }
    },

    methods: {
      /**
       * Fetch notifications.
       *
       * @param {Number} limit
       */
      fetch(limit = 5) {
        axios.get('/notifications', {
            params: {
              limit
            }
          })
          .then(({
            data: {
              total,
              notifications
            }
          }) => {
            this.total = total
            this.notifications = notifications.map(({
              id,
              data,
              created
            }) => {
              return {
                id: id,
                title: data.title,
                body: data.body,
                created: created,
                action_url: data.action_url
              }
            })
          })
      },

      /**
       * Mark the given notification as read.
       *
       * @param {Object} notification
       */
      markAsRead({
        id
      }) {
        const index = this.notifications.findIndex(n => n.id === id)

        if (index > -1) {
          this.total--
            this.notifications.splice(index, 1)
          axios.patch(`/notifications/${id}/read`)
        }
      },

      /**
       * Mark all notifications as read.
       */
      markAllRead() {
        this.total = 0
        this.notifications = []

        axios.post('/notifications/mark-all-read')
      },

      /**
       * Listen for Echo push notifications.
       */
      listen() {
        window.Echo.private(`App.User.${window.Laravel.user.id}`)
          .notification(notification => {
            this.total++
              this.notifications.unshift(notification)
          })
          .listen('NotificationRead', ({
            notificationId
          }) => {
            this.total--

              const index = this.notifications.findIndex(n => n.id === notificationId)
            if (index > -1) {
              this.notifications.splice(index, 1)
            }
          })
          .listen('NotificationReadAll', () => {
            this.total = 0
            this.notifications = []
          })
      },

      /**
       * Initialize the notifications dropdown.
       */
      initDropdown() {
        const dropdown = $(this.$refs.dropdown)

        $(document).on('click', (e) => {
          if (!dropdown.is(e.target) && dropdown.has(e.target).length === 0 &&
            !$(e.target).parent().hasClass('notification-mark-read')) {
            dropdown.removeClass('open')
          }
        })
      },

      /**
       * Toggle the notifications dropdown.
       */
      toggleDropdown() {
        $(this.$refs.dropdown).toggleClass('open')
      }
    }
  }
</script>

<style lang="css" scoped>
      .has-notification {
        z-index: 999;
        position: absolute;
        background: #ffc06a;
        border: 1.5px solid #ffffff;
        padding: 3.5px 3.5px;
        border-radius: 20px;
        top: 11px;
        right: 13px;
    }

    .notification {
      padding:17px 25px;
    }
</style>